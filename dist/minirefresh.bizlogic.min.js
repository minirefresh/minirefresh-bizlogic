/**
 * minirefresh-bizlogic - 基于minirefresh的业务二次封装，包括接口数据自动处理，上拉翻页自动处理等
 * @version v0.0.1
 * @author dailc(dailichun@aliyun.com)
 * https://github.com/minirefresh/minirefresh-bizlogic
 */
!function(t){var e=1,i=0,n=null;t.getNameSpaceObj=function(t,e){if(!e)return n;for(var i=e.split("."),s=i.length,a=0;a<s;a++)t&&(t=t[i[a]]);return t},t.dataProcessFn=[],t.dataProcess=function(s,a){a=a||{};var o=[].slice.call(arguments),r={code:i,message:"",data:n,debugInfo:{type:"未知数据格式"}};if(void 0===a.dataPath)return s;"string"==typeof a.dataPath&&(a.dataPath=[a.dataPath]);var u=a.isDebug||!1,l=a.dataPath,c=t.dataProcessFn,h=c.length,d=l.length,f=!1;if(!s)return r.message="接口返回数据为空!",r;o.push(r);for(var p=0;!f&&p<d;p++){o[1]=l[p];for(var g=0;!f&&g<h;g++){var m=c[g],v=m.apply(this,o);if(v&&v.data!==n&&(v.code===e||p===d-1)){f=!0,r=v;break}}}return f||(r.message="没有数据处理函数或者接口数据返回格式不符合要求!",r.debugInfo.data=s),u||(r.debugInfo=void 0),r}}(MiniRefreshTools),function(t){function e(e,a,o){if(!(a&&e&&e.ReturnInfo&&e.BusinessInfo))return s;var r={type:"v6数据格式:"+a},u=e.ReturnInfo,l=e.BusinessInfo;if(+u.Code===i)if(+l.Code===i){o.code=i;var c=t.getNameSpaceObj(e,a);c?o.data=c:(o.message=o.message||"指定路径下没有找到数据",o.data=null)}else o.code=n,o.message=l.Description||"接口请求错误,后台业务逻辑处理出错!";else o.code=n,o.message=u.Description||"接口请求错误,后台程序处理出错!";return o.debugInfo=r,o}var i=1,n=0,s=null;t.dataProcessFn.push(e)}(MiniRefreshTools),function(t){function e(e,s,u){if(!(s&&e&&e.status&&e.custom))return a;var l={type:"v7数据格式:"+s},c=e.status;if(u.status=c.code,u.message=c.text,o(c.code)){u.code=i;var h=t.getNameSpaceObj(e,s);h?u.data=h:(u.message=u.message||"指定路径下没有找到数据",u.data=null)}else u.code=n,u.message=u.message||r(c.code);return u.debugInfo=l,u}var i=1,n=0,s=200,a=null,o=function(t){return+t===i||+t===s},r=function(t){var e="status状态错误";return 401===+status.code?e="不合法的输入参数":402===+status.code?e="身份认证失败":500===+status.code?e="接口运行错误":300===+status.code&&(e="业务错误"),e};t.dataProcessFn.push(e)}(MiniRefreshTools),function(t,e){"use strict";var i=t.MiniRefreshBiz||e(t);"undefined"!=typeof module&&module.exports?exports.MiniRefreshBiz=i:"function"==typeof define&&(define.amd||define.cmd)&&define(function(){return i}),t.MiniRefreshBiz=i}("undefined"!=typeof window?window:global,function(t){"use strict";function e(t){if("string"!=typeof t)return t;var e,i=document.createElement("div"),n=document.createDocumentFragment();for(i.innerHTML=t;e=i.firstChild;)n.appendChild(e);return n}function i(t){var e=this;t=o.extend(!0,{},p,t);var i=t.template;if("string"==typeof i&&/^[.#]/.test(i)||i instanceof HTMLElement){var n=o.selector(i);n&&(i=n.innerHTML.toString()||"")}t.template=i;var s=t.theme||r;if(!s)throw new Error("错误:请检查传入的minirefresh主题是否正确!");var a=t.setting;a.container=t.container,a.down&&(a.down.callback=function(){e._pullDownCallback()}),a.up&&(a.up.callback=function(){e._pullUpCallback()}),this.container=o.selector(t.container),this.listContainer=o.selector(t.listContainer),this.options=t,this.setting=a,this._initParams(),this.instance=new s(a),this._addEvent()}var n="log",s="warn",a="error",o=window.MiniRefreshTools,r=window.MiniRefresh,u=window.Mustache,l=window.mui,c=mui.ajax,h=o.dataProcess,d="ontouchstart"in document,f=d?"tap":"click",p={isDebug:!1,container:"#minirefresh",listContainer:"#listdata",type:"POST",initPageIndex:0,url:null,template:"#item-template",dataRequest:null,dataChange:null,itemClick:null,success:null,error:null,pullDown:null,isAutoRender:!0,itemSelector:"li",delay:0,timeout:6e3,accepts:{script:"text/javascript, application/javascript, application/x-javascript",json:"application/json",xml:"application/xml, text/xml",html:"text/html",text:"text/plain"},contentType:"application/x-www-form-urlencoded",headers:null,setting:{down:{},up:{isAuto:!0}}};return i.prototype={_log:function(t,e){this.options.isDebug&&console[t](e)},_initParams:function(){this.isNoMoreData=!1,this.currPage=this.options.initPageIndex,this.setting.up&&this.setting.up.auto&&this.currPage--},_pullDownCallback:function(){var t=this,e=this.options;this.loadingDown||(this.isPullDown=!0,this.loadingDown=!0,this.currPage=e.initPageIndex,setTimeout(function(){t._ajaxRequest()},e.delay),e.pullDown&&e.pullDown())},_pullUpCallback:function(){var t=this;this.loadingUp||(this.isPullDown=!1,this.loadingUp=!0,this.currPage++,setTimeout(function(){t._ajaxRequest()},this.options.delay))},_clearResponseEl:function(){this.options.isAutoRender&&this.listContainer&&(this.listContainer.innerHTML="")},_render:function(t){var i=this.options,n=0;if(i.isAutoRender)if(this.isPullDown&&this._clearResponseEl(),u)if(t&&Array.isArray(t)&&t.length>0){for(var s="",o=0,r=t.length;o<r;o++){var l=t[o],c="",h=i.template;h&&("string"==typeof h?c=h:"function"==typeof h&&(c=h(l))),s+=u.render(c,l),n++}""!==s&&this.listContainer.appendChild(e(s))}else this.isNoMoreData=!0;else this.isNoMoreData=!0,this._log(a,"error***没有包含mustache文件,无法进行模板渲染");return n},_dataChangeDefault:function(t){var e=h(t,{dataPath:["custom.infoList","custom.infolist","UserArea.InfoList"]});return e.data},_ajaxRequest:function(){var t=this,e=this.options;if(!e.url)return this._log(a,"error***url无效,无法访问"),void this._errorRequest(null,null,"请求url为空!");var i=function(i){var n="";n="function"==typeof e.url?e.url():e.url,c({url:n,data:i,dataType:"json",timeout:e.timeout,type:e.type,accepts:e.accepts,headers:e.headers,contentType:e.contentType,success:function(e){t._successRequest(e)},error:function(e,i){t._errorRequest(e,i,"请求失败!")}})};if(e.dataRequest){var n=e.dataRequest(this.currPage,function(t){i(t)});void 0!==n&&i(n)}else this._log(s,"warning***请注意dataRequest不存在,默认数据为空"),i()},_errorRequest:function(t,e,i){var n=this.options;this._refreshState(!1),this.currPage--,this.currPage=this.currPage>=n.initPageIndex?this.currPage:n.initPageIndex,n.error&&n.error(t,e,i)},_successRequest:function(t){var e=this.options;if(!t)return this._log(s,"warning***返回的数据为空,请注意！"),this.isNoMoreData=!0,void this._refreshState(!1);this._log(n,"下拉刷新返回数据:"+JSON.stringify(t)),t=e.dataChange?e.dataChange(t):this._dataChangeDefault(t);var i=this._render(t);this.loadingMoreSuccess&&(this.loadingMoreSuccess(),this.loadingMoreSuccess=null),e.success&&"function"==typeof e.success&&e.success(t,this.isPullDown||this.currPage===e.initPageIndex),this._refreshState(!0,i)},_refreshState:function(t,e){var i=this.instance;e=e||0,this.isPullDown&&(i.endDownLoading(t,"更新"+e+"条数据"),this.isNoMoreData&&(i.resetUpLoading(),this.isNoMoreData=!1)),i.endUpLoading(this.isNoMoreData),this.loadingDown=!1,this.loadingUp=!1},_addEvent:function(){var t=this.listContainer,e=this.options,i=e.itemClick;"function"==typeof i&&l(t).on(f,e.itemSelector,i)},refresh:function(){var t=this.options;!t.up||this.instance.options.up.isLock?(this._clearResponseEl(),this._pullDownCallback()):this.loadingUp||(this._clearResponseEl(),this.currPage=t.initPageIndex-1,this.loadingMore())},loadingMore:function(t){var e=this.instance;this.loadingMoreSuccess=t,this.isNoMoreData&&(e.resetUpLoading(),this.isNoMoreData=!1),e.triggerUpLoading()},refreshSetting:function(t){this.setting=o.extend(!0,{},this.setting,t),this.instance.refreshOptions(this.setting)},destroy:function(){l(this.listContainer).off(),this.container=null,this.listContainer=null,this.instance=null,this.options=null}},i});